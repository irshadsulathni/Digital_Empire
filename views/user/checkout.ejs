<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Molla - Bootstrap eCommerce Template</title>
    <meta name="keywords" content="HTML5 Template">
    <meta name="description" content="Molla - Bootstrap eCommerce Template">
    <meta name="author" content="p-themes">
    <!-- Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="/userAssets/images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/userAssets/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/userAssets/images/icons/favicon-16x16.png">
    <link rel="manifest" href="/userAssets/images/icons/site.html">
    <link rel="mask-icon" href="/userAssets/images/icons/safari-pinned-tab.svg" color="#666666">
    <link rel="shortcut icon" href="/userAssets/images/icons/favicon.ico">
    <meta name="apple-mobile-web-app-title" content="Molla">
    <meta name="application-name" content="Molla">
    <meta name="msapplication-TileColor" content="#cc9966">
    <meta name="msapplication-config" content="/userAssets/images/icons/browserconfig.xml">
    <meta name="theme-color" content="#ffffff">
    <!-- Plugins CSS File -->
    <link rel="stylesheet" href="/userAssets/css/bootstrap.min.css">
    <!-- Main CSS File -->
    <link rel="stylesheet" href="/userAssets/css/style.css">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.0/toastify.min.css">
    <!-- Add Toastify CSS -->
    <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
    <!-- Add Toastify JS -->
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <!-- Include Toastr CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">

    <!-- Include Toastr JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    <!-- SweetAlert CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.css">

    <!-- SweetAlert JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sweetalert/2.1.2/sweetalert.min.js"></script>

    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>


    <style>
        .page-content {
            padding: 20px 0;
        }

        .checkout-discount {
            padding: 20px;
            background-color: #f9f9f9;
            border: 1px solid #dedede;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .checkout-discount .input-group {
            max-width: 400px;
            margin: 0 auto;
        }

        .checkout-discount .form-control {
            border-right: 0;
            border-radius: 20px 0 0 20px;
            height: 45px;
            padding: 10px 20px;
        }

        .checkout-discount .input-group-append .btn {
            border-radius: 0 20px 20px 0;
            height: 45px;
            padding: 10px 20px;
        }

        .checkout-discount label {
            display: block;
            margin-top: 15px;
            font-size: 16px;
            color: #555;
        }

        .checkout-discount label span {
            cursor: pointer;
            text-decoration: underline;
        }

        .checkout-discount a {
            display: block;
            margin-top: 20px;
            font-size: 16px;
            color: #007bff;
            text-decoration: none;
        }

        .checkout-discount a:hover {
            text-decoration: underline;
        }

        .checkout-title {
            font-size: 24px;
            margin-bottom: 20px;
            color: #333;
        }

        .card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .card h5 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .card p {
            margin-bottom: 10px;
        }

        .summary {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        .summary-title {
            font-size: 22px;
            margin-bottom: 20px;
            color: #333;
        }

        .table-summary {
            width: 100%;
            margin-bottom: 20px;
        }

        .table-summary th,
        .table-summary td {
            padding: 10px;
            border-top: 1px solid #e0e0e0;
        }

        .btn-order {
            background-color: #007bff;
            color: #fff;
            border-radius: 20px;
            padding: 10px 20px;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        .btn-order:hover {
            background-color: #0056b3;
        }

        @media (max-width: 767px) {
            .checkout-discount .input-group {
                flex-direction: column;
            }

            .checkout-discount .form-control,
            .checkout-discount .input-group-append .btn {
                border-radius: 20px;
                margin-bottom: 10px;
                border: 1px solid #dedede;
            }

            .checkout-discount .input-group-append .btn {
                border-radius: 0 0 20px 20px;
            }
        }

        /* offer modal */

        .modal-lg {
            max-width: 50%;
        }

        .card {
            transition: transform 0.5s;
        }

        .card:hover {
            transform: scale(1.05);
        }

        .coupon-expiry {
            font-weight: bold;
        }

        .coupon-expiry.expired {
            color: red;
        }


    </style>
</head>

<body>
    <div class="page-wrapper">
        <header class="header">
            <%- include('../layouts/pageHeader') %>
        </header><!-- End .header -->

        <main class="main">
            <div class="page-header text-center" style="background-image: url('/userAssets/images/page-header-bg.jpg')">
                <div class="container">
                    <h1 class="page-title">Checkout<span>Shop</span></h1>
                </div><!-- End .container -->
            </div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/shop">Shop</a></li>
                        <li class="breadcrumb-item"><a href="/cart">Cart</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Checkout</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="checkout">
                    <div class="container">
                        <!-- Discount Section -->
                        <div class="checkout-discount mb-4">
                            <form id="coupon-form">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Enter your coupon code" required id="checkout-discount-input">
                                    <div class="input-group-append">
                                        <button class="btn btn-primary" type="submit">Apply</button>
                                    </div>
                                </div>
                            </form>
                            <!-- <button class="btn btn-secondary" id="remove-coupon-button" style="display: none;">Remove Coupon</button> -->
                            
                            <!-- Trigger Button -->
                                <!-- Trigger Button -->
                                <a href="javascript:void(0);" class="btn btn-link mt-3 d-block text-center" data-toggle="modal" data-target="#couponModal">
                                    View Available Coupons
                                </a>

                                <!-- Modal Structure -->
                                <div class="modal fade" id="couponModal" tabindex="-1" role="dialog" aria-labelledby="couponModalLabel" aria-hidden="true">
                                    <div class="modal-dialog modal-lg" role="document">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title" id="couponModalLabel">Available Coupons</h5>
                                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                                    <span aria-hidden="true">&times;</span>
                                                </button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <% if (coupons.length > 0) { %>
                                                        <% coupons.forEach(function(coupon) { %>
                                                            <% if (!coupon.usersList.some(userCoupon => userCoupon.userId.equals(userData._id) && userCoupon.coupenUsed)) { %>
                                                                <div class="col-md-6 mb-4">
                                                                    <div class="card h-100">
                                                                        <div class="card-body">
                                                                            <h5 class="card-title text-center">
                                                                                <%= coupon.name %>
                                                                            </h5>
                                                                            <ul class="list-unstyled">
                                                                                <li><strong>Amount:</strong> <%= coupon.amount %></li>
                                                                                <li><strong>Minimum Purchase Amount:</strong> <%= coupon.minimumAmount %></li>
                                                                                <% if (!coupon.usersList.some(userCoupon => userCoupon.userId.equals(userData._id))) { %>
                                                                                    <li><strong>Coupon Code:</strong> <%= coupon.coupenCode %></li>
                                                                                <% } %>
                                                                                <li><strong>Expires:</strong>
                                                                                    <% if (coupon.expired) { %>
                                                                                        <span class="coupon-expiry <%= coupon.expired < new Date() ? 'expired' : '' %>">
                                                                                            <%= coupon.expired.toDateString() %>
                                                                                        </span>
                                                                                    <% } else { %>
                                                                                        <span class="text-muted">N/A</span>
                                                                                    <% } %>
                                                                                </li>
                                                                            </ul>
                                                                            <% if (!coupon.usersList.some(userCoupon => userCoupon.userId.equals(userData._id))) { %>
                                                                                <button class="btn btn-primary btn-sm copy-coupon" data-coupon="<%= coupon.coupenCode %>">Copy Coupon Code</button>
                                                                            <% } else { %>
                                                                                <p class="text-muted">Coupon already used</p>
                                                                            <% } %>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            <% } %>
                                                        <% }); %>
                                                    <% } else { %>
                                                        <div class="col-12">
                                                            <p class="text-center">No coupons available at the moment.</p>
                                                        </div>
                                                    <% } %>
                                                </div>
                                                
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                            <div id="coupon-message" class="text-center mt-2"></div>
                        </div>
                        <!-- End Discount Section -->

                        <!-- Billing Details Form -->
                        <form id="orderForm">
                            <div class="row">
                                <!-- Billing Details -->
                                <div class="col-lg-9 mb-4">
                                    <h2 class="checkout-title">Billing Details</h2>
                                    <p>You Can Add up to 5 Addresses (<%= 5 - addressData.length %> remaining).</p>
                                    <% if (addressData.length < 5) { %>
                                        <p><a href="/address" class="text-primary">Add new Address <i
                                                    class="fas fa-edit"></i></a></p>
                                        <% } %>

                                            <div class="row">
                                                <% addressData.forEach(element=> { %>
                                                    <div class="col-md-6 mb-3">
                                                        <div class="card p-3 h-100">
                                                            <label for="<%= element._id %>">
                                                                <input type="radio" id="<%= element._id %>"
                                                                    name="selectedAddress" value="<%= element._id %>">
                                                                <h5><span class="icon">📍</span> Address</h5>
                                                                <div><strong>Name:</strong>
                                                                    <%= element.fullName %>
                                                                </div>
                                                                <div><strong>Mob:</strong>
                                                                    <%= element.phoneNumber %>
                                                                </div>
                                                                <div><strong>Address:</strong>
                                                                    <%= element.addressLine1 %>, <%=
                                                                            element.addressLine2 %>
                                                                </div>
                                                                <div>
                                                                    <%= element.city %>, <%= element.state %>
                                                                </div>
                                                                <div><strong>Zip Code:</strong>
                                                                    <%= element.postalCode %>
                                                                </div>
                                                            </label>
                                                            <a href="/editAddress?addressId=<%= element._id %>"
                                                                class="text-primary mt-2 d-block">Edit <i
                                                                    class="fas fa-edit"></i></a>
                                                        </div>
                                                    </div>
                                                    <% }) %>
                                            </div>
                                </div>
                                <!-- End Billing Details -->

                                <!-- Order Summary -->
                                <aside class="col-lg-3">
                                    <div class="summary">
                                        <h3 class="summary-title">Your Order</h3>
                                        <table class="table table-summary">
                                            <thead>
                                                <tr>
                                                    <th>Product</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody id="order-summary">
                                                <% if (cartData && cartData.product && cartData.product.length > 0) { %>
                                                    <% cartData.product.forEach(element => { %>
                                                        <% if (element.productId) { %>
                                                            <tr>
                                                                <td><a href="#"><%= element.productId.productName %></a></td>
                                                                <td>₹<%= element.subTotal %></td>
                                                            </tr>
                                                        <% } else { %>
                                                            <tr>
                                                                <td colspan="2">Product information is missing.</td>
                                                            </tr>
                                                        <% } %>
                                                    <% }) %>
                                                <% } else { %>
                                                    <tr>
                                                        <td colspan="2">No products in cart</td>
                                                    </tr>
                                                <% } %>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td>Subtotal</td>
                                                    <td id="subtotal">₹<span id="subtotal-value"><%= cartData && cartData.cartTotal ? cartData.cartTotal : '0.00' %></span></td>
                                                </tr>
                                                <tr id="discount-row" style="display: none;">
                                                    <td>Discount</td>
                                                    <td id="discount-amount">-₹<span id="discount-value">0.00</span></td>
                                                </tr>
                                                <tr>
                                                    <td>Total</td>
                                                    <td id="total">₹<span id="total-value"><%= cartData && cartData.total ? cartData.total : '0.00' %></span></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                
                                        <div class="accordion-summary" id="accordion-payment-1">
                                            <div class="card">
                                                <div class="card-header" id="heading-1">
                                                    <h2 class="card-title">
                                                        <input type="radio" value="COD" name="paymentMethod">
                                                        <span>Cash On Delivery</span>
                                                    </h2>
                                                </div>
                                            </div>
                                        </div>
                                
                                        <div class="accordion-summary" id="accordion-payment-2">
                                            <div class="card">
                                                <div class="card-header" id="heading-2">
                                                    <h2 class="card-title">
                                                        <input type="radio" value="Razorpay" name="paymentMethod">
                                                        <span>Razorpay</span>
                                                    </h2>
                                                </div>
                                            </div>
                                        </div>
                                
                                        <div class="accordion-summary" id="accordion-payment-3">
                                            <div class="card">
                                                <div class="card-header" id="heading-3">
                                                    <h2 class="card-title">
                                                        <input type="radio" value="Wallet" name="paymentMethod">
                                                        <span>Wallet</span>
                                                    </h2>
                                                </div>
                                            </div>
                                        </div>
                                
                                        <button id="rzp-button1" onclick="placeOrderFn(event)" type="button" class="btn btn-outline-primary-2 btn-order btn-block">
                                            <span class="btn-text">Place Order</span>
                                            <span class="btn-hover-text">Proceed to Checkout</span>
                                        </button>
                                    </div>
                                </aside>
                                
                                

                                <!-- End Order Summary -->
                            </div>
                        </form>
                    </div>
                </div>
            </div>

        </main><!-- End .main -->

        <%- include('../layouts/pageFooter') %>
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->
    <div class="mobile-menu-overlay"></div><!-- End .mobile-menu-overlay -->

    <!-- Plugins JS File -->
    <script src="/userAssets/js/jquery.min.js"></script>
    <script src="/userAssets/js/bootstrap.bundle.min.js"></script>
    <script src="/userAssets/js/jquery.hoverIntent.min.js"></script>
    <script src="/userAssets/js/jquery.waypoints.min.js"></script>
    <script src="/userAssets/js/superfish.min.js"></script>
    <script src="/userAssets/js/owl.carousel.min.js"></script>
    <!-- Main JS File -->
    <script src="/userAssets/js/main.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Include Toastify JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastify-js/1.11.0/toastify.min.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        function placeOrder(paymentMethod) {
            var selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked');
            var selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
            const couponCode = document.getElementById('checkout-discount-input').value;
            console.log(couponCode);
            if (!selectedAddressId) {
                Toastify({
                    text: "Please select an address.",
                    duration: 3000,
                    gravity: "top",
                    backgroundColor: "orange"
                }).showToast();
                return;
            }
    
            if (!selectedPaymentMethod) {
                Toastify({
                    text: "Please select a payment method.",
                    duration: 3000,
                    gravity: "top",
                    backgroundColor: "orange"
                }).showToast();
                return;
            }
    
            var orderData = {
                selectedAddress: selectedAddressId.value,
                paymentMethod: selectedPaymentMethod.value,
                couponCode:couponCode
            };
    
            if (paymentMethod === 'Razorpay') {
                createRazorpayOrder(orderData);
            } else {
                placeOrderAxios(orderData);
            }

        }

    
        // function createRazorpayOrder(orderData) {
        //     axios.post('/createOrder', { orderData })
        //         .then(response => {
        //             var options = {
        //                 "key": "rzp_test_ADhVz53VKpu01p",
        //                 "amount": response.data.razorpayOrder.amount,
        //                 "currency": "INR",
        //                 "name": "Your Company",
        //                 "description": "Order Payment",
        //                 "image": "https://example.com/your_logo.png",
        //                 "order_id": response.data.razorpayOrder.id,
        //                 "handler": function (response) {
        //                     const paymentData = {
        //                         razorpay_payment_id: response.razorpay_payment_id,
        //                         razorpay_order_id: response.razorpay_order_id,
        //                         razorpay_signature: response.razorpay_signature
        //                     };
        //                     axios.post('/verifyPayment', paymentData)
        //                         .then(response => {
        //                             Swal.fire({
        //                                 icon: 'success',
        //                                 title: 'Success',
        //                                 text: 'Payment successful and verified!',
        //                             }).then(() => {
        //                                 window.location.href = `/loadsuccessPage?orderId=${response.data.orderId}`;
        //                             });
        //                         })
        //                         .catch(err => {
        //                             console.error(err);
        //                             Swal.fire({
        //                                 icon: 'error',
        //                                 title: 'Error',
        //                                 text: 'Payment verification failed!',
        //                             });
        //                         });
        //                 },
        //                 "prefill": {
        //                     "name": "Customer Name",
        //                     "email": "customer@example.com",
        //                     "contact": "9999999999"
        //                 },
        //                 "notes": {
        //                     "address": "Customer Address"
        //                 },
        //                 "theme": {
        //                     "color": "#F37254"
        //                 }
        //             };
        //             var rzp1 = new Razorpay(options);
                    
        //             rzp1.on('payment.failed', function (response) {
        //                 console.error(response.error);
        //                 Swal.fire({
        //                     icon: 'error',
        //                     title: 'Error',
        //                     text: 'Payment failed. Please try again.'
        //                 });
        //             });
        //             rzp1.open();
        //         })
        //         .catch(error => {
        //             console.error(error);
        //             Swal.fire({
        //                 icon: 'error',
        //                 title: 'Error',
        //                 text: 'Failed to create order. Please try again.'
        //             });
        //         });
        // }


        function createRazorpayOrder(orderData) {
    axios.post('/createOrder', { orderData })
        .then(response => {
            var options = {
                "key": "rzp_test_ADhVz53VKpu01p",
                "amount": response.data.razorpayOrder.amount,
                "currency": "INR",
                "name": "Your Company",
                "description": "Order Payment",
                "image": "https://example.com/your_logo.png",
                "order_id": response.data.razorpayOrder.id,
                "handler": function (response) {
                    const paymentData = {
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_signature: response.razorpay_signature
                    };
                    axios.post('/verifyPayment', paymentData)
                        .then(response => {
                            Swal.fire({
                                icon: 'success',
                                title: 'Success',
                                text: 'Payment successful and verified!',
                            }).then(() => {
                                window.location.href = `/loadsuccessPage?orderId=${response.data.orderId}`;
                            });
                        })
                        .catch(err => {
                            console.error(err);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error',
                                text: 'Payment verification failed!',
                            });
                        });
                },
                "prefill": {
                    "name": "Customer Name",
                    "email": "customer@example.com",
                    "contact": "9999999999"
                },
                "notes": {
                    "address": "Customer Address"
                },
                "theme": {
                    "color": "#F37254"
                }
            };

            var rzp1 = new Razorpay(options);

            rzp1.on('payment.failed', function (response) {
                console.error(response.error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Payment failed. Redirecting to home page.'
                }).then(() => {
                    window.location.href = '/'; // Redirect to home page
                });

                axios.post('/paymentFailed', { orderId: response.error.metadata.order_id })
                    .then(response => {
                        console.log('Order status updated to Payment Pending and cart cleared');
                    })
                    .catch(err => {
                        console.error('Failed to update order status:', err);
                    });
            });

            rzp1.open();
        })
        .catch(error => {
            console.error(error);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to create order. Please try again.'
            });
        });
}

function placeOrderAxios(orderData) {
    axios.post('/orders', orderData)
        .then(response => {
            window.location.href = `/loadsuccessPage?orderId=${response.data.orderId}`;
        })
        .catch(error => {
            if (error.response) {
                if (error.response.status === 500 && error.response.data.message === 'Amount to want use razorpay or Wallet') {
                    Toastify({
                        text: "Amount exceeds, please use razorpay or Wallet.",
                        duration: 3000,
                        gravity: "top",
                        backgroundColor: "red",
                        onClose: function () {
                            window.location.href = "/cart";
                        }
                    }).showToast();
                } else if (error.response.status === 500 && error.response.data.message === 'Insufficient stock for product') {
                    const { name, stock, qty } = error.response.data;
                    Toastify({
                        text: `Insufficient stock for ${name}. Stock available: ${stock}. Requested quantity: ${qty}`,
                        duration: 3000,
                        gravity: "top",
                        backgroundColor: "red",
                        onClose: function () {
                            window.location.href = "/cart";
                        }
                    }).showToast();
                } else if (error.response.status === 404 && error.response.data === "Cart data not found") {
                    Toastify({
                        text: "Your cart is empty. Please add items to your cart before placing an order.",
                        duration: 3000,
                        gravity: "bottom",
                        backgroundColor: "orange"
                    }).showToast();
                } else {
                    Toastify({
                        text: "Failed to place order. Please try again later.",
                        duration: 3000,
                        gravity: "bottom",
                        backgroundColor: "red"
                    }).showToast();
                }
            } else {
                Toastify({
                    text: "An unexpected error occurred. Please try again later.",
                    duration: 3000,
                    gravity: "bottom",
                    backgroundColor: "red"
                }).showToast();
            }
        });
}

        async function placeOrderWithWallet(orderData) {
        try {
            const response = await axios.post('/createWalletOrder', orderData);
            Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Order placed successfully!',
            }).then(() => {
                window.location.href = `/loadsuccessPage?orderId=${response.data.orderId}`;
            });
        } catch (error) {
            console.log(error);
            let message = 'Failed to place order using Wallet. Please try again later.';
            if (error.response && error.response.data && error.response.data.error) {
                message = error.response.data.error;
            }
            Toastify({
                text: message,
                duration: 3000,
                gravity: "bottom",
                backgroundColor: "red"
            }).showToast();
        }
    }
    
        const placeOrderFn = (e) => {
            e.preventDefault();
            var selectedAddressId = document.querySelector('input[name="selectedAddress"]:checked');
            var selectedPaymentMethod = document.querySelector('input[name="paymentMethod"]:checked');
    
            if (!selectedAddressId) {
                Toastify({
                    text: "Please select an address.",
                    duration: 3000,
                    gravity: "top",
                    backgroundColor: "orange"
                }).showToast();
                return;
            }
    
            if (!selectedPaymentMethod) {
                Toastify({
                    text: "Please select a payment method.",
                    duration: 3000,
                    gravity: "top",
                    backgroundColor: "orange"
                }).showToast();
                return;
            }
    
            var orderData = {
                selectedAddress: selectedAddressId.value,
                paymentMethod: selectedPaymentMethod.value
            };
    
            if (selectedPaymentMethod.value === 'COD') {
                placeOrder('COD');
            } else if (selectedPaymentMethod.value === 'Razorpay') {
                placeOrder('Razorpay');
            } else if (selectedPaymentMethod.value === 'Wallet') {
                placeOrderWithWallet(orderData);
            }
        }


        /// apply coupen 


        function updateCartDisplay(cartTotal, total, discount) {
    // document.getElementById('subtotal').innerText = `₹${cartTotal}`;
    document.getElementById('total').innerText = `₹${total}`;

    if (discount > 0) {
        document.getElementById('discount-amount').innerText = `-₹${discount}`;
        document.getElementById('discount-row').style.display = 'table-row';
    } else {
        document.getElementById('discount-row').style.display = 'none';
        document.getElementById('discount-amount').innerText = `-₹0`;
    }
}

document.getElementById('coupon-form').addEventListener('submit', function (event) {
    event.preventDefault();
    const couponCode = document.getElementById('checkout-discount-input').value;
    const cartTotal = parseFloat(document.getElementById('subtotal').innerText.replace('₹', ''));

    fetch('/applyCoupon', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ couponCode: couponCode, cartTotal: cartTotal })
    })
    .then(response => response.json())
    .then(data => {
    if (data.success) {
        Swal.fire({
            icon: 'success',
            title: 'Coupon Applied',
            text: data.message || 'Coupon applied successfully!'
        });
        updateCartDisplay(data.cartTotal, data.total, data.discount);
        // document.getElementById('remove-coupon-button').style.display = 'block';
    } else {
        Swal.fire({
            icon: 'info',
            title: 'Error',
            text: data.message || 'Failed to apply coupon'
        });
    }
})

    .catch(error => {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'An error occurred while applying the coupon'
        });
        console.error('Error:', error);
    });
});

// document.getElementById('remove-coupon-button').addEventListener('click', function () {
//     const cartTotal = parseFloat(document.getElementById('subtotal').innerText.replace('₹', ''));

//     fetch('/removeCoupon', {
//         method: 'POST',
//         headers: {
//             'Content-Type': 'application/json'
//         },
//         body: JSON.stringify({ cartTotal: cartTotal })
//     })
//     .then(response => response.json())
//     .then(data => {
//     if (data.success) {
//         Swal.fire({
//             icon: 'success',
//             title: 'Coupon Removed',
//             text: data.message || 'Coupon removed successfully!'
//         });
//         updateCartDisplay(data.cartTotal, data.total, data.discount);
//         document.getElementById('checkout-discount-input').value = '';
//         document.getElementById('remove-coupon-button').style.display = 'none';
//     } else {
//         Swal.fire({
//             icon: 'error',
//             title: 'Error',
//             text: data.message || 'Failed to remove coupon'
//         });
//     }
// })

//     .catch(error => {
//         Swal.fire({
//             icon: 'error',
//             title: 'Error',
//             text: 'An error occurred while removing the coupon'
//         });
//         console.error('Error:', error);
//     });
// });

    </script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.copy-coupon').forEach(button => {
            button.addEventListener('click', function() {
                const couponCode = this.getAttribute('data-coupon');
                navigator.clipboard.writeText(couponCode).then(() => {
                    Swal.fire({
                        icon: 'success',
                        title: 'Coupon Code Copied!',
                        text: `Coupon code ${couponCode} copied to clipboard.`,
                        showConfirmButton: false,
                        timer: 1500
                    });
                }).catch(err => {
                    console.error('Failed to copy coupon code: ', err);
                    Swal.fire({
                        icon: 'error',
                        title: 'Failed to Copy',
                        text: 'There was an error copying the coupon code.',
                    });
                });
            });
        });
    });
</script>




</body>

</html>